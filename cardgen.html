<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Robot Player-Card Generator</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f7fa;
      padding: 2rem;
      line-height: 1.4;
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 1rem;
    }

    .preview-wrapper {
      margin-bottom: 1rem;
    }

    /* ── Card ───────────────────────────────────────── */
    .card {
      width: 320px;
      padding: 1rem 1.25rem;
      border-radius: 1rem;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 4px solid transparent;
      transition: border-color 0.3s ease;
    }

    .card h2 {
      font-size: 1.35rem;
      margin: 0 0 0.5rem;
      word-break: break-word;
    }

      .stats p {
        display: flex;
        justify-content: space-between;
        margin: 0.15rem 0;
      }

      .stars {
        text-align: center;
        color: #f1c40f;
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
      }

    /* ── Buttons ────────────────────────────────────── */
    button {
      padding: 0.55rem 1rem;
      border: none;
      border-radius: 0.6rem;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.08s ease;
    }
    button:hover {
      transform: translateY(-2px);
    }
    /* Preview button removed */
    #download-btn {
      background: #10b981;
      color: #fff;
      display: inline-block;
    }
  </style>

  <!-- html2canvas for PNG download -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- Shared helpers provided by your site -->
  <script src="shared.js"></script>
</head>
<body>
  <h1>Robot Player-Card Generator</h1>

    <div style="margin-bottom:1rem;">
      <label for="tank-upload">Tank image:</label>
      <input id="tank-upload" type="file" accept="image/*" style="display:none;" />
      <button id="edit-image-btn" type="button">Edit Image</button>
    </div>

    <div style="margin-bottom:1rem;">
      <label for="json-upload">Robot JSON:</label>
      <input id="json-upload" type="file" accept="application/json" style="display:none;" />
      <button id="edit-json-btn" type="button">Edit JSON</button>
    </div>

    <div style="margin-bottom:1rem;">
      <label for="code-input">Card code:</label>
      <input id="code-input" type="text" />
    </div>

    <div class="preview-wrapper">
      <div id="card" class="card" style="display:none;">
        <div id="star-rating" class="stars"></div>
        <img id="tank-image" src="" alt="Tank preview" style="width:100%;border-radius:0.5rem;margin-bottom:0.5rem;display:none;" />
        <h2 id="robot-name">My Awesome Bot</h2>
        <div id="robot-meta" style="font-size:0.85rem;margin-bottom:0.5rem;display:none;"></div>
        <div class="stats" id="stats"><!-- Injected here --></div>
      </div>
      <div id="description-card" style="margin-top:1rem;"></div>
    </div>

  <button id="download-btn">Download PNG</button>

  <script>
    /*
      Assumes the following functions are available from shared.js:
        - getScore(gameID)          → Number
        - hslToRgb(h, s, l)         → [r, g, b]
        - rgbToHsl(r, g, b)         → [h, s, l]
    */

    function generateBotDescription(botData) {
      const countryEmojiMap = {
        us: "\uD83C\uDDFA\uD83C\uDDF8",
        dk: "\uD83C\uDDE9\uD83C\uDDF0",
        ca: "\uD83C\uDDE8\uD83C\uDDE6",
        gb: "\uD83C\uDDEC\uD83C\uDDE7",
        de: "\uD83C\uDDE9\uD83C\uDDEA",
        fr: "\uD83C\uDDEB\uD83C\uDDF7",
        jp: "\uD83C\uDDEF\uD83C\uDDF5",
        cn: "\uD83C\uDDE8\uD83C\uDDF3",
        in: "\uD83C\uDDEE\uD83C\uDDF3",
        kr: "\uD83C\uDDF0\uD83C\uDDF7",
        br: "\uD83C\uDDE7\uD83C\uDDF7",
        se: "\uD83C\uDDF8\uD83C\uDDEA"
      };

      const languageEmojiMap = {
        "Java": "\u2615",
        "Java 11": "\u2615",
        "C": "\uD83D\uDCBE",
        "C++": "\uD83D\uDCBB",
        "Python": "\uD83D\uDC0D",
        "Python 3": "\uD83D\uDC0D"
      };

      const {
        name,
        version,
        authors = [],
        description = "",
        homepage = "",
        countryCodes = [],
        platform = "",
        programmingLang = ""
      } = botData;

      const flagEmojis = countryCodes.length > 0 ? countryCodes.map(code => countryEmojiMap[code.toLowerCase()] || `\u26f3\uFE0F(${code})`).join(" ") : "";
      const authorList = authors.length > 0 ? authors.map(name => `<div class="author">\uD83D\uDC64 ${name}</div>`).join("") : "";
      const languageEmoji = languageEmojiMap[programmingLang] || "\uD83D\uDCA1";
      const siteLink = homepage ? `<a href="${homepage}" target="_blank">Visit Site</a>` : "";

      return `
        <div style="
          background: #fbeec1;
          border: 4px solid #333;
          border-radius: 12px;
          padding: 16px;
          max-width: 400px;
          font-family: 'Verdana', sans-serif;
          box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
          color: #222;
        ">
          <div style="font-size: 1.5em; font-weight: bold;">\uD83E\uDD16 ${name || "Unnamed Bot"} ${version ? `<span style="font-size: 0.7em;">v${version}</span>` : ""}</div>
          ${flagEmojis ? `<div style="margin: 8px 0;">${flagEmojis}</div>` : ""}
          ${authorList ? `<div style="margin-bottom: 8px;">${authorList}</div>` : ""}
          ${description ? `<div style="font-style: italic; margin-bottom: 12px;">${description}</div>` : ""}
          ${platform ? `<div><strong>\uD83E\uDDE0 Platform:</strong> ${platform}</div>` : ""}
          ${programmingLang ? `<div><strong>\uD83D\uDCBB Language:</strong> ${languageEmoji} ${programmingLang}</div>` : ""}
          ${siteLink ? `<div><strong>\uD83C\uDF10 Website:</strong> ${siteLink}</div>` : ""}
        </div>
      `;
    }

    const GAME_IDS = [1, 2, 3, 4];
    const MAX_SCORES = {1: 50, 2: 50, 3: 50, 4: 4};
    const MAX_TOTAL = Object.values(MAX_SCORES).reduce((a, b) => a + b, 0);
    let codeBonus = 0;
    let robotInfo = null;

    function updateCodeBonus() {
      const code = document.getElementById("code-input").value.trim();
      if (/^\d.*[abc]$/.test(code)) {
        codeBonus = (code.match(/%/g) || []).length;
      } else {
        codeBonus = 0;
      }
    }

    /** Utility: builds a single stat line */
    function statLine(label, value) {
      const p = document.createElement("p");
      p.innerHTML = `<span>${label}</span><span>${value}</span>`;
      return p;
    }

    function renderRobotMeta() {
      const metaEl = document.getElementById("robot-meta");
      if (!robotInfo) {
        metaEl.style.display = "none";
        metaEl.innerHTML = "";
        return;
      }
      metaEl.style.display = "block";
      const lines = [];
      if (robotInfo.version) lines.push(`<strong>Version:</strong> ${robotInfo.version}`);
      if (robotInfo.authors) lines.push(`<strong>Authors:</strong> ${robotInfo.authors.join(', ')}`);
      if (robotInfo.description) lines.push(robotInfo.description);
      if (robotInfo.homepage) lines.push(`<strong>Homepage:</strong> <a href='${robotInfo.homepage}' target='_blank'>${robotInfo.homepage}</a>`);
      if (robotInfo.countryCodes) lines.push(`<strong>Country:</strong> ${robotInfo.countryCodes.join(', ').toUpperCase()}`);
      if (robotInfo.platform) lines.push(`<strong>Platform:</strong> ${robotInfo.platform}`);
      if (robotInfo.programmingLang) lines.push(`<strong>Language:</strong> ${robotInfo.programmingLang}`);
      metaEl.innerHTML = lines.map(l => `<p>${l}</p>`).join('');
      document.getElementById("robot-name").textContent = robotInfo.name || "My Awesome Bot";
    }

    function renderBotDescription() {
      const descEl = document.getElementById("description-card");
      if (!robotInfo) {
        descEl.innerHTML = "";
        return;
      }
      descEl.innerHTML = generateBotDescription(robotInfo);
    }

    /** Populates the card with current scores */
   function buildCard() {
     const statsEl = document.getElementById("stats");
     const starEl = document.getElementById("star-rating");
    statsEl.innerHTML = ""; // Clear previous

      renderRobotMeta();
      renderBotDescription();

      let total = 0;
      GAME_IDS.forEach((id) => {
        const score = getScore(id) || 0;
        total += score;
        statsEl.appendChild(statLine(`Game ${id}`, score));
      });
      statsEl.appendChild(statLine("<strong>Total</strong>", `<strong>${total}</strong>`));

      updateCodeBonus();
      const scoreForStars = total + codeBonus;
      const starCount = Math.min(12, Math.round((scoreForStars / MAX_TOTAL) * 12));
      starEl.textContent = "★".repeat(starCount);

      // Color theme — map total score (0-400) onto hue (0-120)
      const hue = Math.max(0, Math.min(120, total));
      const [r, g, b] = hslToRgb(hue / 360, 0.65, 0.5);
      const borderColor = `rgb(${r}, ${g}, ${b})`;
      document.getElementById("card").style.borderColor = borderColor;
    }

    // ── Initialize and periodic updates ───────────────
    const uploadEl = document.getElementById("tank-upload");
    const jsonUploadEl = document.getElementById("json-upload");
    const imgEl = document.getElementById("tank-image");
    const cardEl = document.getElementById("card");
    const codeInputEl = document.getElementById("code-input");
    const editImgBtn = document.getElementById("edit-image-btn");
    const editJsonBtn = document.getElementById("edit-json-btn");

    codeInputEl.addEventListener("input", () => {
      updateCodeBonus();
      buildCard();
    });
    let intervalId = null;

    editImgBtn.addEventListener("click", () => uploadEl.click());
    editJsonBtn.addEventListener("click", () => jsonUploadEl.click());

    function loadStoredData() {
      const storedImg = localStorage.getItem("robotCard:image");
      const storedJson = localStorage.getItem("robotCard:json");
      if (storedImg) {
        imgEl.src = storedImg;
        imgEl.style.display = "block";
        cardEl.style.display = "block";
      }
      if (storedJson) {
        try { robotInfo = JSON.parse(storedJson); } catch {}
      }
      if (storedImg || storedJson) {
        buildCard();
        if (!intervalId) intervalId = setInterval(buildCard, 60000);
      }
    }

    loadStoredData();

    uploadEl.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        imgEl.src = ev.target.result;
        imgEl.style.display = "block";
        cardEl.style.display = "block";
        localStorage.setItem("robotCard:image", ev.target.result);
        buildCard();
        if (!intervalId) {
          intervalId = setInterval(buildCard, 60000);
        }
      };
      reader.readAsDataURL(file);
    });

    jsonUploadEl.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          robotInfo = JSON.parse(ev.target.result);
          localStorage.setItem("robotCard:json", ev.target.result);
        } catch (err) {
          alert("Invalid JSON file");
          robotInfo = null;
        }
        cardEl.style.display = "block";
        buildCard();
        if (!intervalId) {
          intervalId = setInterval(buildCard, 60000);
        }
      };
      reader.readAsText(file);
    });

    document.getElementById("download-btn").addEventListener("click", () => {
      html2canvas(document.getElementById("card"), { scale: 2 }).then((canvas) => {
        const link = document.createElement("a");
        link.download = "robot_card.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    });
  </script>
</body>
</html>
